// Equipment Catalog Script for Sustainability Lending Library

// Include mock data generator
document.write('<script src="mock-data.js"></script>');

// Google Sheets Integration Configuration
const SHEET_ID = '1pZALS1ddDWNGpnTZadEIoCfFOviRdQ45wZfm62lZQ3o';
const API_KEY = 'AIzaSyAvj2ZNkJCUqJ8DBa608DH2Jvd6caV4kVQ';
const SHEET_NAME = 'Inventory';

// Store inventory data globally
let inventoryData = [];

// Define category icons
const categoryIcons = {
    'Event Supplies': 'üì¶',
    'Technology': 'üíª',
    'Craft Supplies': 'üé®',
    'Office Supplies': 'üìé',
    'Sustainability Tools': '‚ôªÔ∏è',
    'Safety': 'üßØ',
    'Tools': 'üîß',
    'Other': 'üõ†Ô∏è'
};

// Item image mapping - replace with your actual image paths
const itemImages = {
    // Default for items without a specific image
    'default': 'https://via.placeholder.com/300x300.png?text=No+Image'
};

// Create placeholder images for demo purposes
function createPlaceholderImages() {
    // List of items that need placeholder images
    const itemsNeeding = [
        '6ft Folding Table', 'Table Top Chalk Board', 'Tent Canopy', 
        'A-Frame/Sandwich Board', 'Clothing Rack', 'Spinning Prize Wheel',
        'Steel Easel Stand', 'Bluetooth Speaker', 'Outlet Killowatt Meter',
        '10 ft HDMI Cord', 'Cord Adapter/Dongle', 'Solar Power Bank',
        'Screen Printing Kit', 'Button Maker', 'Cricut EasyPress'
    ];
    
    // For each item, assign a colored placeholder
    const colors = ['87CEEB', 'E8F5E9', 'FFF3E0', 'F3E5F5', 'E1F5FE', 'FFFDE7', 'F1F8E9', 'E0F7FA'];
    
    itemsNeeding.forEach((item, index) => {
        const color = colors[index % colors.length];
        const formattedName = encodeURIComponent(item);
        itemImages[item] = `https://via.placeholder.com/300x300/${color}/00274C.png?text=${formattedName}`;
    });
}

// Load inventory data when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Create placeholder images for items without real images
    createPlaceholderImages();
    
    // Load inventory data
    loadInventoryData();
    
    // Add event listeners for filters
    document.getElementById('category-filter').addEventListener('change', applyFilters);
    document.getElementById('availability-filter').addEventListener('change', applyFilters);
    document.getElementById('search-input').addEventListener('input', applyFilters);
});

// Function to load inventory data from Google Sheets
function loadInventoryData() {
    // Show loading indicator
    document.getElementById('loading-container').style.display = 'block';
    
    // Use mock data instead of actual API call due to connectivity issues
    mockSheetsFetch()
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Process the returned data
            if (data.values && data.values.length > 0) {
                inventoryData = data.values;
                displayEquipment();
            } else {
                showLoadingError("No inventory data found in the spreadsheet.");
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            showLoadingError("Error loading equipment data. Please try again later.");
        });
}

// Show loading error
function showLoadingError(message) {
    const loadingContainer = document.getElementById('loading-container');
    loadingContainer.innerHTML = `
        <p>${message}</p>
        <button class="button" onclick="loadInventoryData()">Retry</button>
    `;
}

// Function to display equipment by categories
function displayEquipment() {
    const container = document.getElementById('equipment-categories-container');
    const loadingContainer = document.getElementById('loading-container');
    
    // Hide loading container
    loadingContainer.style.display = 'none';
    
    // Clear container
    container.innerHTML = '';
    
    // Check if we have inventory data
    if (!inventoryData || inventoryData.length < 2) {
        container.innerHTML = '<div class="no-items">No equipment data available.</div>';
        return;
    }
    
    // Group items by category
    const categories = {};
    
    // Skip header row (index 0)
    for (let i = 1; i < inventoryData.length; i++) {
        const row = inventoryData[i];
        if (row.length < 4) continue; // Skip incomplete rows
        
        const category = row[1] || 'Other';
        
        if (!categories[category]) {
            categories[category] = [];
        }
        
        categories[category].push({
            itemName: row[0] || 'Unknown Item',
            category: category,
            totalQuantity: row[2] || '0',
            available: row[3] || '0',
            condition: row[4] || 'N/A',
            location: row[5] || 'N/A',
            notes: row[6] || '',
            index: i
        });
    }
    
    // Sort categories alphabetically
    const sortedCategories = Object.keys(categories).sort();
    
    // Create section for each category
    sortedCategories.forEach(category => {
        const items = categories[category];
        
        // Create category section
        const categorySection = document.createElement('div');
        categorySection.className = 'category-section';
        categorySection.dataset.category = category;
        
        // Create category header
        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'category-header';
        categoryHeader.innerHTML = `
            <div class="category-icon">
                <span>${categoryIcons[category] || 'üì¶'}</span>
            </div>
            <h2 class="category-title">${category}</h2>
        `;
        
        // Create equipment grid
        const equipmentGrid = document.createElement('div');
        equipmentGrid.className = 'equipment-grid';
        
        // Add items to grid
        items.forEach(item => {
            const available = parseInt(item.available);
            const isAvailable = available > 0;
            
            // Get image for the item
            const imageSrc = itemImages[item.itemName] || itemImages['default'];
            
            // Create item element
            const itemElement = document.createElement('div');
            itemElement.className = 'equipment-item';
            itemElement.dataset.name = item.itemName.toLowerCase();
            itemElement.dataset.category = category.toLowerCase();
            itemElement.dataset.available = isAvailable ? 'available' : 'unavailable';
            
            itemElement.innerHTML = `
                <div class="equipment-image">
                    <div class="quantity-badge">${available} of ${item.totalQuantity} Available</div>
                    <div class="status-indicator ${isAvailable ? 'status-available' : 'status-unavailable'}">
                        ${isAvailable ? 'Available' : 'Currently In Use'}
                    </div>
                    <img src="${imageSrc}" alt="${item.itemName}">
                </div>
                <div class="equipment-content">
                    <h3 class="equipment-name">${item.itemName}</h3>
                    <p class="equipment-details">${item.notes || 'No description available for this item.'}</p>
                    <div class="equipment-actions">
                        <a href="request-form.html?item=${encodeURIComponent(item.itemName)}" class="request-button">Request Item</a>
                        <a href="#" class="view-details" onclick="showItemDetails(${item.index}); return false;">View Details</a>
                    </div>
                </div>
            `;
            
            equipmentGrid.appendChild(itemElement);
        });
        
        // Add header and grid to category section
        categorySection.appendChild(categoryHeader);
        categorySection.appendChild(equipmentGrid);
        
        // Add category section to container
        container.appendChild(categorySection);
    });
    
    // Apply initial filters in case they were set
    applyFilters();
}// Equipment Catalog Script for Sustainability Lending Library

// Google Sheets Integration
const SHEET_ID = '1pZALS1ddDWNGpnTZadEIoCfFOviRdQ45wZfm62lZQ3o';
const API_KEY = 'AIzaSyAvj2ZNkJCUqJ8DBa608DH2Jvd6caV4kVQ';
const SHEET_NAME = 'Inventory';

// Store inventory data globally
let inventoryData = [];

// Define category icons
const categoryIcons = {
    'Event Supplies': 'üì¶',
    'Technology': 'üíª',
    'Craft Supplies': 'üé®',
    'Office Supplies': 'üìé',
    'Sustainability Tools': '‚ôªÔ∏è',
    'Safety': 'üßØ',
    'Tools': 'üîß',
    'Other': 'üõ†Ô∏è'
};

// Item image mapping - replace with your actual image paths
const itemImages = {
    // Event Supplies
    '6ft Folding Table': 'assets/6ft_folding_table.png',
    'Table Top Chalk Board': 'assets/table_top_chalk_board.png',
    'Tent Canopy': 'assets/tent_canopy.png',
    'A-Frame/Sandwich Board': 'assets/sandwich_board.jpg',
    'Clothing Rack': 'assets/clothing_rack.jpeg',
    'Spinning Prize Wheel': 'assets/prize_wheel.jpg',
    'Steel Easel Stand': 'assets/easel.jpg',
    
    // Technology
    'Bluetooth Speaker': 'assets/bluetooth_speaker.png',
    'Outlet Killowatt Meter': 'assets/outlet_kilowatt_meter.png',
    '10 ft HDMI Cord': 'assets/10ft_hdmi_cord.png',
    'Cord Adapter/Dongle': 'assets/adapter.jpg',
    'Solar Power Bank': 'assets/solar_power_bank.jpg',
    
    // Craft Supplies
    'Screen Printing': 'assets/screen_printing.jpeg',
    'Button Maker': 'assets/button_maker.png',
    'Cricut EasyPress': 'assets/cricut_easypress.jpg',
    
    // Default for items without a specific image
    'default': 'assets/ll_default.png'
};

// Create placeholder images for demo purposes
function createPlaceholderImages() {
    // List of items that need placeholder images
    const itemsNeeding = [
        '6ft Folding Table', 'Table Top Chalk Board', 'Tent Canopy', 
        'A-Frame/Sandwich Board', 'Clothing Rack', 'Spinning Prize Wheel',
        'Steel Easel Stand', 'Bluetooth Speaker', 'Outlet Killowatt Meter',
        '10 ft HDMI Cord', 'Cord Adapter/Dongle', 'Solar Power Bank',
        'Screen Printing', 'Button Maker', 'Cricut EasyPress'
    ];
    
    // Create a canvas element to generate placeholders
    const canvas = document.createElement('canvas');
    canvas.width = 300;
    canvas.height = 300;
    const ctx = canvas.getContext('2d');
    
    // For each item, generate a colored placeholder with text
    itemsNeeding.forEach((item, index) => {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Set background color (cycle through different colors)
        const colors = ['#e3f2fd', '#e8f5e9', '#fff3e0', '#f3e5f5', '#e1f5fe', '#fffde7'];
        ctx.fillStyle = colors[index % colors.length];
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Add item name
        ctx.fillStyle = '#00274c';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        
        // Split long item names
        const words = item.split(' ');
        let y = 140;
        if (words.length > 2) {
            const firstLine = words.slice(0, Math.ceil(words.length/2)).join(' ');
            const secondLine = words.slice(Math.ceil(words.length/2)).join(' ');
            ctx.fillText(firstLine, 150, y);
            ctx.fillText(secondLine, 150, y + 30);
        } else {
            ctx.fillText(item, 150, 150);
        }
        
        // Add a simple icon
        ctx.fillStyle = '#6eb43f';
        ctx.beginPath();
        ctx.arc(150, 90, 30, 0, Math.PI * 2);
        ctx.fill();
        
        // Convert to data URL
        const dataUrl = canvas.toDataURL('image/png');
        
        // Store as a temporary image that can be used
        itemImages[item] = dataUrl;
    });
}

// Load inventory data when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Create placeholder images for items without real images
    createPlaceholderImages();
    
    // Load inventory data
    loadInventoryData();
    
    // Add event listeners for filters
    document.getElementById('category-filter').addEventListener('change', applyFilters);
    document.getElementById('availability-filter').addEventListener('change', applyFilters);
    document.getElementById('search-input').addEventListener('input', applyFilters);
});

// Function to load inventory data from Google Sheets
function loadInventoryData() {
    const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
    
    // Show loading indicator
    document.getElementById('loading-container').style.display = 'block';
    
    fetch(sheetUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Process the returned data
            if (data.values && data.values.length > 0) {
                inventoryData = data.values;
                displayEquipment();
            } else {
                showLoadingError("No inventory data found in the spreadsheet.");
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
            showLoadingError("Error loading equipment data. Please try again later.");
        });
}

// Show loading error
function showLoadingError(message) {
    const loadingContainer = document.getElementById('loading-container');
    loadingContainer.innerHTML = `
        <p>${message}</p>
        <button class="button" onclick="loadInventoryData()">Retry</button>
    `;
}

// Function to display equipment by categories
function displayEquipment() {
    const container = document.getElementById('equipment-categories-container');
    const loadingContainer = document.getElementById('loading-container');
    
    // Hide loading container
    loadingContainer.style.display = 'none';
    
    // Clear container
    container.innerHTML = '';
    
    // Check if we have inventory data
    if (!inventoryData || inventoryData.length < 2) {
        container.innerHTML = '<div class="no-items">No equipment data available.</div>';
        return;
    }
    
    // Group items by category
    const categories = {};
    
    // Skip header row (index 0)
    for (let i = 1; i < inventoryData.length; i++) {
        const row = inventoryData[i];
        if (row.length < 4) continue; // Skip incomplete rows
        
        const category = row[1] || 'Other';
        
        if (!categories[category]) {
            categories[category] = [];
        }
        
        categories[category].push({
            itemName: row[0] || 'Unknown Item',
            category: category,
            totalQuantity: row[2] || '0',
            available: row[3] || '0',
            condition: row[4] || 'N/A',
            location: row[5] || 'N/A',
            notes: row[6] || '',
            index: i
        });
    }
    
    // Sort categories alphabetically
    const sortedCategories = Object.keys(categories).sort();
    
    // Create section for each category
    sortedCategories.forEach(category => {
        const items = categories[category];
        
        // Create category section
        const categorySection = document.createElement('div');
        categorySection.className = 'category-section';
        categorySection.dataset.category = category;
        
        // Create category header
        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'category-header';
        categoryHeader.innerHTML = `
            <div class="category-icon">
                <span>${categoryIcons[category] || 'üì¶'}</span>
            </div>
            <h2 class="category-title">${category}</h2>
        `;
        
        // Create equipment grid
        const equipmentGrid = document.createElement('div');
        equipmentGrid.className = 'equipment-grid';
        
        // Add items to grid
        items.forEach(item => {
            const available = parseInt(item.available);
            const isAvailable = available > 0;
            
            // Get image for the item
            const imageSrc = itemImages[item.itemName] || itemImages['default'];
            
            // Create item element
            const itemElement = document.createElement('div');
            itemElement.className = 'equipment-item';
            itemElement.dataset.name = item.itemName.toLowerCase();
            itemElement.dataset.category = category.toLowerCase();
            itemElement.dataset.available = isAvailable ? 'available' : 'unavailable';
            
            itemElement.innerHTML = `
                <div class="equipment-image">
                    <div class="quantity-badge">${available} of ${item.totalQuantity} Available</div>
                    <div class="status-indicator ${isAvailable ? 'status-available' : 'status-unavailable'}">
                        ${isAvailable ? 'Available' : 'Currently In Use'}
                    </div>
                    <img src="${imageSrc}" alt="${item.itemName}">
                </div>
                <div class="equipment-content">
                    <h3 class="equipment-name">${item.itemName}</h3>
                    <p class="equipment-details">${item.notes || 'No description available for this item.'}</p>
                    <div class="equipment-actions">
                        <a href="request-form.html?item=${encodeURIComponent(item.itemName)}" class="request-button">Request Item</a>
                        <a href="#" class="view-details" onclick="showItemDetails(${item.index}); return false;">View Details</a>
                    </div>
                </div>
            `;
            
            equipmentGrid.appendChild(itemElement);
        });
        
        // Add header and grid to category section
        categorySection.appendChild(categoryHeader);
        categorySection.appendChild(equipmentGrid);
        
        // Add category section to container
        container.appendChild(categorySection);
    });
    
    // Apply initial filters in case they were set
    applyFilters();
}

// Function to apply filters
function applyFilters() {
    const categoryFilter = document.getElementById('category-filter').value;
    const availabilityFilter = document.getElementById('availability-filter').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
    
    // Get all category sections and items
    const categorySections = document.querySelectorAll('.category-section');
    const items = document.querySelectorAll('.equipment-item');
    
    // Hide all category sections initially
    categorySections.forEach(section => {
        section.style.display = 'none';
    });
    
    // Show/hide items based on filters
    let visibleItems = 0;
    
    items.forEach(item => {
        const itemCategory = item.dataset.category;
        const itemAvailability = item.dataset.available;
        const itemName = item.dataset.name;
        
        const categoryMatch = categoryFilter === 'all' || itemCategory === categoryFilter.toLowerCase();
        const availabilityMatch = availabilityFilter === 'all' || itemAvailability === availabilityFilter;
        const searchMatch = !searchTerm || itemName.includes(searchTerm);
        
        if (categoryMatch && availabilityMatch && searchMatch) {
            item.style.display = '';
            visibleItems++;
            
            // Show the parent category section
            const parentSection = item.closest('.category-section');
            parentSection.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
    
    // Check if any items are visible
    if (visibleItems === 0) {
        const container = document.getElementById('equipment-categories-container');
        // Check if no results message already exists
        if (!document.getElementById('no-results-message')) {
            const noResults = document.createElement('div');
            noResults.id = 'no-results-message';
            noResults.className = 'no-items';
            noResults.textContent = 'No equipment matches your search criteria. Please try different filters.';
            container.appendChild(noResults);
        }
    } else {
        // Remove no results message if it exists
        const noResults = document.getElementById('no-results-message');
        if (noResults) {
            noResults.remove();
        }
    }
}

// Function to show item details (in a modal)
function showItemDetails(index) {
    const item = inventoryData[index];
    
    if (!item || item.length < 4) {
        alert('Item details not available.');
        return;
    }
    
    const itemName = item[0] || 'Unknown Item';
    const category = item[1] || 'N/A';
    const total = item[2] || '0';
    const available = item[3] || '0';
    const condition = item[4] || 'N/A';
    const location = item[5] || 'N/A';
    const notes = item[6] || 'No additional information available.';
    
    // Create modal dynamically
    const modalBackdrop = document.createElement('div');
    modalBackdrop.className = 'modal-backdrop';
    modalBackdrop.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    // Get image for the item
    const imageSrc = itemImages[itemName] || itemImages['default'];
    
    // Create modal content
    modalBackdrop.innerHTML = `
        <div style="
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        ">
            <button onclick="this.parentNode.parentNode.remove()" style="
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #777;
            ">&times;</button>
            
            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                <div style="flex: 1; min-width: 200px;">
                    <img src="${imageSrc}" alt="${itemName}" style="
                        max-width: 100%;
                        max-height: 250px;
                        object-fit: contain;
                        display: block;
                        margin: 0 auto 20px;
                    ">
                </div>
                <div style="flex: 2; min-width: 250px;">
                    <h2 style="margin-top: 0; color: #00274c; font-size: 24px;">${itemName}</h2>
                    <p><strong>Category:</strong> ${category}</p>
                    <p><strong>Availability:</strong> ${available} of ${total}</p>
                    <p><strong>Condition:</strong> ${condition}</p>
                    <p><strong>Storage Location:</strong> ${location}</p>
                    <div style="margin-top: 20px;">
                        <h3 style="color: #00274c;">Additional Information</h3>
                        <p>${notes}</p>
                    </div>
                </div>
            </div>
            <div style="margin-top: 30px; text-align: center;">
                <a href="request-form.html?item=${encodeURIComponent(itemName)}" style="
                    background-color: #6eb43f;
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    text-decoration: none;
                    font-weight: bold;
                    display: inline-block;
                ">Request This Item</a>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.appendChild(modalBackdrop);
    
    // Close modal when clicking outside
    modalBackdrop.addEventListener('click', function(event) {
        if (event.target === modalBackdrop) {
            modalBackdrop.remove();
        }
    });
}
